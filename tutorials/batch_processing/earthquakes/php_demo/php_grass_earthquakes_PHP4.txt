<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<head>
  <title>GRASS/PHP Server Sample page: Current Earthquakes</title>
  <meta name="Author" content="Markus Neteler, 2006">
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
</head>
<body bgcolor="#FFFFFF">

<h2>Recent Earthquakes: map generated by GRASS on the fly with PHP</h2>
<P>
Software: Apache, PHP4, GRASS 6
<P>
What happens here?<br>
The server is fetching the current list of earthquakes from
<i>http://neic.usgs.gov/neis/gis/bulletin.asc</i>
and generates a vector map with attributes from that. The result is overlayed to the
Blue Marble Next Generation map from May.

<?php
  // FOR DEBUG ONLY: Show all information, defaults to INFO_ALL
  // uncomment next line to check if and which version of PHP is running:
//phpinfo();
?>

<?php
  // PHP 4, doesn't work with PHP5 (see instead:
  //       http://grass.itc.it/spearfish/php_grass_earthquakes.php )
  //
  // Quick-and-dirty implementation. Complaints to /dev/null, 
  // suggestions to <neteler itc it>
  //
  // Home: http://grass.itc.it/spearfish/php_grassmap.php 
  //
  // Inspired by:
  // http://grass.itc.it/pipermail/grass5/2004-August/015106.html
  //
  // Possible improvements:
  //       - use PHP session to avoid race conditions
  //         (use session name as mapset etc)
  //       - replace system calls by GRASS-SWIG-PHP interface

  // Approach:
  //    GRASS is simply a set of commands which need to be run in
  //    a pre-defined environment. A map is generated as PNG file
  //    and then visualized.
  //    To keep it simple, we use system commands. Note the trailing
  //    semicolon for each command, otherwise it won't work.
  // Prerequisites:
  //    Add 'MONITOR: PNG' to the .grassrc6 file (see GISRC below). 
  //    Update also the path to the location. This and GRASS location need
  //    owner/group of Web server (e.g. 'apache' user/group) as the
  //    Web server software launches GRASS.
  //    Also this directory where the files/map is generated, needs to
  //    be owned by the Web server user.
  //
  // ---------------------
  // 1. define the environment settings:
  putenv("GISBASE=/usr/local/grass-6.1.cvs");
  putenv("PATH=/bin:/usr/bin:/usr/local/bin:/usr/local/grass-6.1.cvs/bin:/usr/local/grass-6.1.cvs/scripts");
  putenv("LD_LIBRARY_PATH=/lib:/usr/lib:/usr/local/grass-6.1.cvs/lib");

  // note that the GRASS location needs owner/group of Web server (e.g. 'apache' user/group)
  putenv("GISRCRC=/grass0/neteler/www/spearfish/.grassrc6_ll");
  putenv("GISRC=/tmp/gisrc");

  // also the output files need owner/group of Web server:
  putenv("GRASS_PNGFILE=earthquakes.png");
  putenv("GRASS_TRUECOLOR=TRUE");
  putenv("GRASS_WIDTH=900");
  putenv("GRASS_PNG_COMPRESSION=1");

  putenv("HOME=/tmp");
  putenv("GIS_LOCK=$$");

  // Debug only:
  system("env > environment_vars2.txt");

  // fetch & polish earthquake data:
  system("
    lynx -dump http://neic.usgs.gov/neis/gis/bulletin.asc > /tmp/bulletin.tmp;
    cat /tmp/bulletin.tmp | sed 's+ ++g' | grep -v ',,' | grep -v '^$' > bulletin.asc;
   ");

  // 2. Now we start to process things and create a map:
  // cleanup stuff from previous session
  system("rm -f grasserrors2.txt grassmsgs2.txt;");

  // watch out for quotes-in-quotes in SQL commands:
  //
  // Next comment just left for me:
  // #optimal class table
  // # http://earthquake.usgs.gov/eqcenter/recenteqsww/glossary.php#class
  // #d.vect.thematic recent_earthquakes column=class type=point themetype=graduated_points maxsize=20 nint=6 >> grassmsgs2.txt;
  // #
  // # http://neic.usgs.gov/neis/gis/recent.asc seems to be buggy recently (4/2006)
  //
  // 3. GRASS session....

  // Debug only: simple GRASS command:
  //   system("g.version > version_info2.txt 2> grasserrors2.txt");
  system("
    g.gisenv;
    g.region -d ;
    d.mon PNG 2>> grasserrors2.txt;

    cat bulletin.asc | v.in.ascii out=recent_earthquakes skip=1 fs=',' y=3 x=4 col='e_date date, e_time varchar(10), lat double precision, long double precision, magnitude double precision, depth double precision' --o >> grassmsgs2.txt ;

    v.db.addcol recent_earthquakes col='class integer' ;
    v.db.update recent_earthquakes col=class value=1 where='magnitude < 3' ;
    v.db.update recent_earthquakes col=class value=2 where='magnitude >=3 AND magnitude < 4' ;
    v.db.update recent_earthquakes col=class value=3 where='magnitude >=4 AND magnitude < 5' ;
    v.db.update recent_earthquakes col=class value=4 where='magnitude >=5 AND magnitude < 6' ;
    v.db.update recent_earthquakes col=class value=5 where='magnitude >=6 AND magnitude < 7' ;
    v.db.update recent_earthquakes col=class value=6 where='magnitude >=8' ;

    d.rast BMNG_May.rgb ;
    echo '<SMALL><PRE>' ;
    d.vect.thematic recent_earthquakes column=class type=point themetype=graduated_points maxsize=20 nint=6 >> grassmsgs2.txt;
    echo '</PRE></SMALL>' ;
    d.mon stop=PNG ;
    g.remove vect=recent_earthquakes ;
    
    rm -f earthquakes_small.jpg ;
    convert -geometry 75% earthquakes.png earthquakes_small.jpg;
    convert -geometry 40% earthquakes.png earthquakes_tiny.jpg; ");
?>

<b>Earthquake classification (circles in map are sized by these classes)</b>
<table border="1" cellpadding="2" cellspacing="0">
<tbody><tr>
<td align="center"><b>Magnitude</b></td>
<td align="center"><b>Classification</b></td>
<td align="center"><b>Class for map</b></td>
</tr>
<tr>
<td align="center">0 - 3</td>
<td align="center">Micro</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">3 - 3.9</td>
<td align="center">Minor</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">4 - 4.9</td>
<td align="center">Light</td>
<td align="center">3</td>
</tr>
<tr>
<td align="center">5 - 5.9</td>
<td align="center">Moderate</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">6 - 6.9</td>
<td align="center">Strong</td>
<td align="center">5</td>
</tr>
<tr>
<td align="center">7 - 7.9</td>
<td align="center">Major</td>
<td align="center">6</td>
</tr>
<tr>
<td align="center">8 and higher</td>
<td align="center">Great</td>
<td align="center">7</td>
</tr>
</tbody></table>
<p>
Here a map should appear:<p>

Oldest event from: 
<?php
 system("head -2 bulletin.asc  | tail -1 | cut -d',' -f1-2 | tr ',' ' '");
?>
UTC ; Latest event from: 
<?php
 system("tail -1 bulletin.asc | cut -d',' -f1-2 | tr ',' ' '");
?>
 UTC <br>
<?php
 system("echo \"`cat bulletin.asc  | grep -vi Date | wc -l | awk '{print $1}'` earthquakes on this map\"");
?>
<br>
Latest events drawn last.
<p>
<a href="earthquakes.png" border="0"><img src="earthquakes_small.jpg" alt="Auto-generated earthquake map (GRASS GIS/PHP based)"></a><br>
<i>Click for high-res map</i>

<p>
For earthquake details, visit <a href="http://earthquake.usgs.gov/eqcenter/recenteqsww/">Latest Earthquakes in the World - Last 7 days</a> from USGS.
<hr>
2006 Markus Neteler (based on comments from Sharyn Namnath and Glynn Clements)
<br>
<a href=php_grass_earthquakes.txt>Download page source code</a>
</body>
</html>
